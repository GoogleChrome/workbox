# sw-broadcast-cache-update

A helper library that uses the Broadcast Channel API to announce when two Response objects differ.

## Installation

`npm install --save-dev sw-broadcast-cache-update`

## Demo

Browse sample source code in the [demo directory](https://github.com/GoogleChrome/sw-helpers/tree/master/projects/sw-broadcast-cache-update/demo), or
[try it out](https://googlechrome.github.io/sw-helpers/sw-broadcast-cache-update/demo/) directly.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### goog.broadcastCacheUpdate

[projects/sw-broadcast-cache-update/src/index.js:24-29](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/index.js#L24-L29 "Source code on GitHub")

### Behavior

[projects/sw-broadcast-cache-update/src/lib/behavior.js:66-155](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/behavior.js#L66-L155 "Source code on GitHub")

**Examples**

```javascript
// Used as an automatically invoked as "behavior" by a RequestWrapper:

const requestWrapper = new goog.runtimeCaching.RequestWrapper({
  cacheName: 'runtime-cache',
  behaviors: [
    new goog.broadcastCacheUpdate.Behavior({channelName: 'cache-updates'})
  ]
});

// Set up a route to match any requests made against the example.com domain.
// The requests will be handled with a stale-while-revalidate policy, and the
// cache update notification behavior, as configured in requestWrapper, will
// be automatically applied.
const route = new goog.routing.RegExpRoute({
  match: ({url}) => url.domain === 'example.com',
  handler: new goog.runtimeCaching.StaleWhileRevalidate({requestWrapper})
});
```

```javascript
// Explicitly invoked usage independent of the goog.routing framework, via
// the notifyIfUpdated() method:

const cacheUpdateBehavior = new goog.broadcastCacheUpdates.Behavior({
  channelName: 'cache-updates'
});

const url = 'https://example.com';
const cacheName = 'runtime-cache';

const cache = await caches.open(cacheName);
const oldResponse = await cache.match(url);
const newResponse = await fetch(url);
await cache.put(url, newResponse);

// Only check for an update if there was a previously cached Response.
if (oldResponse) {
  cacheUpdateBehavior.notifyIfUpdated({
    first: oldResponse,
    second: newResponse,
    cacheName
  });
}
```

#### constructor

[projects/sw-broadcast-cache-update/src/lib/behavior.js:86-92](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/behavior.js#L86-L92 "Source code on GitHub")

Creates a new `Behavior` instance, which is used to compare two
[`Response`](https://developer.mozilla.org/en-US/docs/Web/API/Response)s
and use the [Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
to notify interested parties when those `Response`s differ.

For efficiency's sake, the underlying response bodies are not compared;
only specific response headers are checked.

**Parameters**

-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.channelName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The name that will be used when creating the
               [`BroadcastChannel`](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel/BroadcastChannel).
    -   `$0.headersToCheck` **\[[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)>]** A list of headers that will be
               used to determine whether the `Response`s differ. If not provided,
               the values `['content-length', 'etag', 'last-modified']` are used.
    -   `$0.source` **\[[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)]** An attribution value that will be used in the
               broadcast message to indicate where the update originated. If not
               provided, a
               [default value](constants#defaultSource) will be used.

#### notifyIfUpdated

[projects/sw-broadcast-cache-update/src/lib/behavior.js:146-154](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/behavior.js#L146-L154 "Source code on GitHub")

An explicit method to call from your own code to trigger the comparison of
two [`Response`](https://developer.mozilla.org/en-US/docs/Web/API/Response)
and fire off a notification via the
[Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
if they differ.

**Parameters**

-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.first` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** One of the responses to compare.
               This should not be an [opaque response](http://stackoverflow.com/questions/39109789).
    -   `$0.second` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** Another of the respones to compare.
               This should not be an [opaque response](http://stackoverflow.com/questions/39109789).
    -   `$0.cacheName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Name of the cache the `Response`s belong to.

### broadcastUpdate

[projects/sw-broadcast-cache-update/src/lib/broadcast-update.js:51-65](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/broadcast-update.js#L51-L65 "Source code on GitHub")

Uses the [Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
to notify interested subscribers about a change to a cached resource.

You would not normally call this method directly; it's called automatically
by an instance of the [Behavior](#behavior) class. It's exposed here for the
benefit of developers who would rather not use the full `Behavior`
implementation.

The message that's posted takes the following format, inspired by the
[Flux standard action](https://github.com/acdlite/flux-standard-action#introduction)
format. (Usage of [Flux](https://facebook.github.io/flux/) itself is not at
all required.)

    {
      type: 'CACHE_UPDATED',
      meta: 'sw-broadcast-cache-update',
      payload: {
        cacheName: 'the-cache-name',
        updatedUrl: 'https://example.com/'
      }
    }

**Parameters**

-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.channel` **BroadcastChannel** The `BroadcastChannel` to use.
    -   `$0.cacheName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The name of the cache in which the updated
               `Response` was stored.
    -   `$0.url` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The URL associated with the updated `Response`.
    -   `$0.source` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** A string identifying this library as the source of
               the update message.

### cacheUpdatedMessageType

[projects/sw-broadcast-cache-update/src/lib/constants.js:21-21](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/constants.js#L21-L21 "Source code on GitHub")

### responsesAreSame

[projects/sw-broadcast-cache-update/src/lib/responses-are-same.js:29-38](https://github.com/GoogleChrome/sw-helpers/blob/22ad29135f05f0599df57de01f1556af6218e47d/projects/sw-broadcast-cache-update/src/lib/responses-are-same.js#L29-L38 "Source code on GitHub")

Given two `Response`s, compares several header values to see if they are
the same or not.

**Parameters**

-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.first` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** One of the `Response`s.
    -   `$0.second` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** Another of the `Response`s.
    -   `$0.headersToCheck` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)>** A list of headers that will be
               used to determine whether the `Response`s differ.

Returns **[boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** Whether or not the `Response` objects are assumed to be
        the same.
